name: Deploy OpenScholar API

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  IMAGE: caelusway/open-scholar-inference
  RUNPOD_HOST: mt6rz9fwgoa11u-64411a76@ssh.runpod.io

jobs:
  validate-code:
    runs-on: self-hosted
    name: Validate Python Code
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run syntax validation
      run: |
        echo "Validating Python syntax..."
        python3 -c "
        import ast
        for f in ['main.py', 'handler.py']:
          print(f'Checking {f}...')
          ast.parse(open(f).read())
        print('All Python files have valid syntax')
        "


  deploy-to-runpod:
    runs-on: self-hosted
    needs: validate-code
    name: Deploy to RunPod Server
    steps:
    - name: Check SSH key configuration
      run: |
        if [ -z "${{ secrets.RUNPOD_SSH_KEY }}" ]; then
          echo "WARNING: RunPod SSH key not configured, skipping deployment"
          exit 0
        fi
        echo "SSH key configured, proceeding with deployment"

    - name: Prepare SSH connection
      run: |
        echo "Setting up SSH key for RunPod connection..."
        echo "${{ secrets.RUNPOD_SSH_KEY }}" > runpod_key
        chmod 600 runpod_key

    - name: Checkout and upload code
      run: |
        echo "Uploading code to RunPod..."
        ssh -i runpod_key -o StrictHostKeyChecking=no ${{ env.RUNPOD_HOST }} '
          cd /workspace
          echo "Stopping existing PM2 processes..."
          pm2 stop openscholar-api || echo "No PM2 process found"
          pm2 delete openscholar-api || echo "No PM2 process to delete"
          
          echo "Backing up existing code..."
          rm -rf openscholar-api-backup
          mv openscholar-api openscholar-api-backup || echo "No existing code to backup"
          
          echo "Creating directories..."
          mkdir -p openscholar-api model_cache logs
        '
        
        echo "Copying code to RunPod..."
        scp -i runpod_key -o StrictHostKeyChecking=no -r . ${{ env.RUNPOD_HOST }}:/workspace/openscholar-api/

    - name: Install dependencies and setup
      run: |
        echo "Installing dependencies on RunPod..."
        ssh -i runpod_key -o StrictHostKeyChecking=no ${{ env.RUNPOD_HOST }} '
          cd /workspace/openscholar-api
          echo "Installing Python dependencies..."
          pip3 install -r requirements.txt
          
          echo "Installing PM2 if not exists..."
          which pm2 || npm install -g pm2
          
          echo "Setting up environment..."
          export OPENSCHOLAR_API_KEY="${{ secrets.OPENSCHOLAR_API_KEY }}"
          export API_HOST=0.0.0.0
          export API_PORT=8002
          export PRODUCTION_MODE=true
          export DEBUG_LOGGING=false
        '

    - name: Start application with PM2
      run: |
        echo "Starting application with PM2..."
        ssh -i runpod_key -o StrictHostKeyChecking=no ${{ env.RUNPOD_HOST }} '
          cd /workspace/openscholar-api
          echo "Starting PM2 process..."
          pm2 start main.py --name openscholar-api \
            --interpreter python3 \
            --env OPENSCHOLAR_API_KEY="${{ secrets.OPENSCHOLAR_API_KEY }}" \
            --env API_HOST=0.0.0.0 \
            --env API_PORT=8002 \
            --env PRODUCTION_MODE=true \
            --env DEBUG_LOGGING=false
          
          pm2 save
          pm2 startup || echo "PM2 startup already configured"
          echo "Application started successfully"
        '

    - name: Wait for service startup
      run: |
        echo "Waiting for service to start up..."
        sleep 20
        echo "Service startup wait completed"

    - name: Health check
      run: |
        echo "Performing health check..."
        ssh -i runpod_key -o StrictHostKeyChecking=no ${{ env.RUNPOD_HOST }} '
          echo "Testing API health endpoint..."
          if curl -f http://localhost:8002/health; then
            echo "Health check passed - API is responding"
          else
            echo "Health check failed - API not responding"
            exit 1
          fi
        '

    - name: Cleanup SSH key
      if: always()
      run: |
        echo "Cleaning up SSH key file..."
        rm -f runpod_key

    - name: Deployment summary
      if: success()
      run: |
        echo "**Deployment Complete**" >> $GITHUB_STEP_SUMMARY
        echo "**API URL:** https://mt6rz9fwgoa11u-64411a76-8002.proxy.runpod.net" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Successfully deployed to RunPod" >> $GITHUB_STEP_SUMMARY